<!DOCTYPE html>
<html lang="en" layout:decorate="~{cms_layout_1.html}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="stylesheet" th:href="@{/css/pos/index.css}">
</head>
<body>
<!-- Main content -->
<div class="content" layout:fragment="page_content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-7">
                <div class="d-flex align-items-center">
                    <div class="d-flex nav-item-container ">
                        <div class="nav-item-icon"> <i class="fas fa-th"></i></div>
                       <div class="nav-item-text" id="nav-item-text">Menu</div>
                    </div>
                    <div class="input-group w-75">
                        <input th:id="name" th:name="name" type="text" class="form-control" placeholder="Tìm sản phẩm bởi tên..." />
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" onclick="searchProduct()">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="sale-item-container">
                    <div class="grid-container" id="grid-item-container">
                        <div class="grid-category" th:each="model,item : ${models}" th:attr="data-id=${model.id}, data-name=${model.name}"
                             th:style="'background-color:' + ${model.backgroundColor} + '; color:' + ${model.textColor}"
                             onclick="showProduct(this)">
                            <div th:text="${model.name}"></div>
                            <div class="grid-cate-icon"><i class="fas fa-folder-open"></i></div>
                        </div>
                    </div>
                    <div class="grid-container" id="grid-other-container" style="padding-top: 0">
                        <div class="grid-category" style="color: black; background-color: white" data-toggle="modal" data-target="#addPayment">Thanh toán chung</div>
                    </div>
                </div>
            </div>
            <div class="col-md-5" >
                <div class="card card-default">
                    <div class="card-header checkout-header">
                        <div class="checkout-header-text">Thanh toán</div>
                        <button class="btn btn-secondary" onclick="getPreviousReceipt()"><i class="fa fa-print"></i> In lại hóa đơn trước</button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="borderless-table">
                                <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Giá</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="checkout-product-table">
                                <tr id="not-remove"></tr>
<!--                                <tr>-->
<!--                                    <td>Redbull</td>-->
<!--                                    <td>-->
<!--                                        <input type="number" class="form-control form-control-sm quantity-input"-->
<!--                                                value="1"-->
<!--                                                min="1"-->
<!--                                                max="99"-->
<!--                                                aria-label="Quantity">-->
<!--                                    </td>-->
<!--                                    <td id="product-item-total-price">$5.00</td>-->
<!--                                    <td><button class="btn btn-sm btn-danger remove-item-button"><i class="fas fa-times"></i>-->
<!--                                    </button></td>-->
<!--                                </tr>-->
<!--                                <tr>-->
<!--                                    <td>Sting dafefsrewrewf dsf wefsdf sd</td>-->
<!--                                    <td><input type="number" class="form-control form-control-sm quantity-input"-->
<!--                                               value="1"-->
<!--                                               min="1"-->
<!--                                               max="99"-->
<!--                                               aria-label="Quantity"></td>-->
<!--                                    <td>$5.00</td>-->
<!--                                    <td><button class="btn btn-sm btn-danger remove-item-button"><i class="fas fa-times"></i>-->
<!--                                    </button></td>-->
<!--                                </tr>-->
                                </tbody>
                                <tfoot>
                                <tr class="grand-total">
                                    <td>Tổng phụ</td>
                                    <td></td>
                                    <td id="sub-total-text">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="grand-total">
                                    <td>Thuế</td>
                                    <td></td>
                                    <td id="tax-text">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="grand-total">
                                    <td>Tổng</td>
                                    <td></td>
                                    <td id="total-text">$0.00</td>
                                    <td></td>
                                </tr>
                                </tfoot>

                            </table>
                        </div>
                        <div class="checkout-button-container">
                            <button class="btn btn-success checkout-button m-1" onclick="checkout('cash')">THANH TOÁN BẰNG TIỀN MẶT</button>
                            <button class="btn btn-primary checkout-button m-1" onclick="checkout('paypal')">THANH TOÁN BẰNG PAYPAL</button>
                            <button class="btn btn-danger checkout-button m-1" onclick="cancel()">HỦY THANH TOÁN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-code-modal">
        <div class="modal fade" id="paypalQrCode" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Mã thanh toán</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="links">
                            <img id="modalQrImage" src="" alt="PayPal QR Code"/>
                            <a id="modalPaypalLink" href="#" target="_blank" onclick="openQrWindow(this.href); return false;">
                                Mở mã QR ở tab mới
                            </a>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPayment" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <form action="http://localhost:8086/nexia-cms/payment/save-paypal" method="post" enctype="multipart/form-data" id="create-payment-form">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Thanh toán</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div th:insert="component :: input-text('Mô tả', 'description', null , 0, 255, true, false)"></div>
                                </div>
                                <div th:with="
                                    options=${T(java.util.Arrays).asList('paypal', 'Paypal', 'cash', 'Tiền mặt')}">
                                    <div th:replace="component :: select-default-v2('Phương thức', 'paymentGatewaySelect', null, true, false, ${options})"></div>
                                </div>
                                <input hidden="hidden" name="paymentGateway" id="paymentGateway"></input>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div th:insert="component :: input-number-decimal('Số tiền', 'amount', null, 1, null, false, false, false)"></div>
                                </div>
                                <div th:with="
                                    options=${T(java.util.Arrays).asList( 1, 'Thu phí', 0, 'Hoàn trả')}">
                                    <div th:replace="component :: select-default-v2('Loại thanh toán', 'type', null, true, false, ${options})"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success mr-2" id="create-payment">Thanh toán</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- PAGE JAVASCRIPT CODE -->
<script layout:fragment="content_page_script">
    const gridContainer = $('#grid-item-container');
    const otherGridContainer = $('#grid-other-container');
    const navItemText = $('#nav-item-text');
    const searchInput = $('#name');
    let cartProduct = [];
    const checkoutProductTable = $('#checkout-product-table');
    let subTotal = 0;
    let total = 0;
    let tax = 0;
    const subTotalText = $('#sub-total-text')
    const taxText = $('#tax-text');
    const totalText = $('#total-text');

    $("#name").on("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault(); // stop default form submit
            searchProduct()
        }
    });

    $('#paypalQrCode').on('hidden.bs.modal', function (e) {
       cancel();
    });

    $('#addPayment').on('hidden.bs.modal', function (e) {
        $('#description').val('');
        $('#paymentGatewaySelect').val('paypal');
        $('#paymentGateway').val('paypal');
        $('#amount').val('')
        $('#type').val('1')
        $('#addPayment #paymentGatewaySelect').prop('disabled', false);
        var cashPayment = 'http://localhost:8086/nexia-cms/payment/save-paypal';
        $("#create-payment-form").attr("action", cashPayment);
    });

    var qrModel = "[[${qrCodeImage}]]"
    var paypalLink = "[[${payPalLink}]]"

    if(qrModel !== null && qrModel !== "")
    {
        $('#modalQrImage').attr('src', `data:image/png;base64, ${qrModel}`);
        $('#modalPaypalLink').attr('href', 'http://localhost:8086/nexia-cms/payment/qr-image?url=' + paypalLink);
        $('#paypalQrCode').modal('show');
    }

    const paymentId = "[[${paymentId}]]";
    const shouldReload = "[[${shouldReload}]]"

    if (paymentId !== null && paymentId !== "" ) {
        const pollingInterval = setInterval(checkStatus, 3000);

        async function checkStatus() {
            try {
                const response = await fetch(`http://localhost:8086/nexia-cms/payment/status?paymentId=${paymentId}`);
                const data = await response.json();
                if (data.status === 1) {
                    clearInterval(pollingInterval);
                    const openModal = $('.modal.show');

                    if (openModal.length > 0) {
                        openModal.modal('hide');
                    }

                    if(shouldReload !== null && shouldReload!== "" && shouldReload === "true")
                    {
                        toastSuccess("Thanh toán thành công", 3000);
                        setTimeout(function() {
                            window.location.href = window.location.href;
                        }, 3000);
                    }
                    else {
                        toastSuccess("Thanh toán thành công", 4000);
                    }
                }
                else if(data.status === -1)
                {
                    clearInterval(pollingInterval);
                    const openModal = $('.modal.show');

                    if (openModal.length > 0) {
                        openModal.modal('hide');
                    }

                    if(shouldReload !== null && shouldReload!== "" && shouldReload === "true")
                    {
                        toastError("Thanh toán đã hủy", 3000);
                        setTimeout(function() {
                            window.location.href = window.location.href;
                        }, 3000);
                    }
                    else {
                        toastError("Thanh toán đã hủy", 4000);
                    }
                }

            } catch (error) {
                console.error('Error during polling:', error);
                clearInterval(pollingInterval);
            }
        }


    }

    checkoutProductTable.on('blur', '.quantity-input', function() {

        const $inputField = $(this);
        const $row = $inputField.closest('tr');
        const productId = $row.data('id');
        const $totalPriceCell = $row.find('.product-item-total-price');
        let newQuantity = $inputField.val();
        let found = cartProduct.find(item => item.id == productId);
        if(!newQuantity)
        {
            if (found)
            {
                $inputField.val(found.amount);
            }
            else {
                $inputField.val(1);
            }
        }
        else {
            if (newQuantity > 99)
            {
                $inputField.val(99)
            }
            else if(newQuantity <= 0)
            {
                $inputField.val(1);
            }
        }
        newQuantity = $inputField.val();
        if(found)
        {
            found.amount = newQuantity;
        }
        $totalPriceCell.html("$" + (found.price * newQuantity).toFixed(2));
        calculateTotalPrice();

    });

    function showProduct(el)
    {
        let id = el.getAttribute("data-id");
        let name = el.getAttribute("data-name");
        $.ajax({
            url: "http://localhost:8086/nexia-cms/product/get-from-category",
            dataType: "json",
            data: { id: id },
            type: "GET",
            success: function(response) {
                const data = response.data;
                gridContainer.empty();
                otherGridContainer.empty();
                const newHtmlArray = [];
                $.each(data, function(index, item) {
                    const itemHtml = `
        <div class="grid-category"
             data-id="${item.id}"
             data-price="${item.price}"
             data-name="${item.name}"
             style="background-color: ${item.backgroundColor}; color: ${item.textColor};"
             onclick="addToCart(this)">

            <div>${item.name}</div>
        </div>
    `;
                    newHtmlArray.push(itemHtml);
                });
                gridContainer.html(newHtmlArray.join(''))
                const backHtml = `<div class="grid-category" style="color: white; background-color: red" onclick="backToCategory()">Quay lại</div>`
                otherGridContainer.html(backHtml);
                navItemText.html(name)
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }

    function backToCategory()
    {
        $.ajax({
            url: "http://localhost:8086/nexia-cms/product-category/get-all",
            dataType: "json",
            type: "GET",
            success: function(response) {
                const data = response.data;
                gridContainer.empty();
                otherGridContainer.empty();
                const newHtmlArray = [];
                $.each(data, function(index, item) {
                    const itemHtml = `
        <div class="grid-category"
                 data-id="${item.id}"
                 data-name="${item.name}"
                 style="background-color: ${item.backgroundColor}; color: ${item.textColor};"
                 onclick="showProduct(this)">

                <div>${item.name}</div>
                <div class="grid-cate-icon"><i class="fas fa-folder-open"></i></div>
            </div>
    `;
                    newHtmlArray.push(itemHtml);
                });
                gridContainer.html(newHtmlArray.join(''))
                const backHtml = `<div class="grid-category" style="color: black; background-color: white" data-toggle="modal" data-target="#addPayment">Thanh toán chung</div>`
                otherGridContainer.html(backHtml);
                navItemText.html('Menu')
                searchInput.val("")
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }

    function searchProduct()
    {
        $.ajax({
            url: "http://localhost:8086/nexia-cms/product/find-by-name",
            dataType: "json",
            data: { name: searchInput.val() },
            type: "GET",
            success: function(response) {
                const data = response.data;
                gridContainer.empty();
                otherGridContainer.empty();
                const newHtmlArray = [];
                $.each(data, function(index, item) {
                    const itemHtml = `
        <div class="grid-category"
             data-id="${item.id}"
             data-price="${item.price}"
             data-name="${item.name}"
             style="background-color: ${item.backgroundColor}; color: ${item.textColor};"
             onclick="addToCart(this)">

            <div>${item.name}</div>
        </div>
    `;
                    newHtmlArray.push(itemHtml);
                });
                gridContainer.html(newHtmlArray.join(''))
                const backHtml = `<div class="grid-category" style="color: white; background-color: red" onclick="backToCategory()">Quay lại</div>`
                otherGridContainer.html(backHtml);
                navItemText.html('Tìm kiếm')
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }

    function addToCart(el)
    {
        let id = el.getAttribute("data-id");
        let name = el.getAttribute("data-name");
        let price = el.getAttribute("data-price");
        let found = cartProduct.find(item => item.id ===id);
        if(found && found.amount < 99)
        {
            found.amount = parseInt(found.amount) + 1;
        }
        else if(!found){
            cartProduct.push({id: id, name: name, price: price, amount: 1});
        }
        renderItem()
        calculateTotalPrice()
    }

    function renderItem()
    {
        const newHtmlArray = [];
        $("#checkout-product-table tr").not("#not-remove").remove()
        $.each(cartProduct, function(index, item) {
            let totalPrice = item.price * item.amount;
            totalPrice = totalPrice.toFixed(2);
            const itemHtml = `
                                            <tr data-id="${item.id}">
                                    <td>${item.name}</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm quantity-input"
                                                value="${item.amount}"
                                                min="1"
                                                max="99"
                                                aria-label="Quantity">
                                    </td>
                                    <td class="product-item-total-price">$${totalPrice}</td>
                                    <td><button class="btn btn-sm btn-danger remove-item-button" onclick="removeItem(${item.id})"><i class="fas fa-times"></i>
                                    </button></td>
                                </tr>
            `
            newHtmlArray.push(itemHtml);
        })
        checkoutProductTable.append(newHtmlArray.join(''))
    }

    function calculateTotalPrice() {
        subTotal = 0;
        tax = 0;
        total = 0;

        $.each(cartProduct, function(index, item) {
            let price = item.price * item.amount;
            subTotal += price;
        });

        $.ajax({
            url: "http://localhost:8086/nexia-cms/product/calculate-tax",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(cartProduct),
            success: function(response) {
                tax = response.data; // get tax from backend
                total = subTotal + tax;

                // Update DOM **inside success**
                subTotalText.html('$' + subTotal.toFixed(2));
                taxText.html('$' + tax.toFixed(2));
                totalText.html('$' + total.toFixed(2));

                console.log(subTotal, tax, total);
            },
            error: function(error) {
                console.error("Error:", error);
            }
        });
    }

    function removeItem(id)
    {
        cartProduct = cartProduct.filter(item => item.id != id);
        renderItem()
        calculateTotalPrice()
    }

    function cancel()
    {
        cartProduct = []
        renderItem()
        calculateTotalPrice()
    }

    function checkout(type)
    {
        if(cartProduct.length != 0)
        {
            let paymentUrl = "";
            let orderUrl = "";
            let productAmount = 0;
            $.each(cartProduct, function(index, item) {
                productAmount += item.amount;
            })
            paymentUrl = "http://localhost:8086/nexia-cms/payment/save-pos-checkout";
            orderUrl = "http://localhost:8086/nexia-cms/product-order/save";
            showLoadingAlert()
            $.ajax({
                url: orderUrl + "?type=" + type,   // API endpoint
                type: "POST",           // HTTP method
                contentType: "application/json", // Send JSON
                data: JSON.stringify(cartProduct),
                success: function(response) {
                    let id = response.data;
                    $.ajax({
                        url: paymentUrl,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(
                            {
                                description: "Đơn hàng #" + id + " gồm " + productAmount + " sản phẩm",
                                amount:  total.toFixed(2),
                                paymentGateway: type,
                                type: 1,
                                productOrderId: id
                            }
                        ),
                        success: function(response) {
                            Swal.close()
                            if(type === "cash")
                            {
                                successSwal(id)
                            }
                            else if(type === "paypal")
                            {
                                const data = response.data;

                                if (data && data.qrCodeImage) {

                                    $('#modalQrImage').attr('src', `data:image/png;base64,${data.qrCodeImage}`);

                                    $('#modalPaypalLink').attr('href', 'http://localhost:8086/nexia-cms/payment/qr-image?url=' + data.paypalLink);

                                    $('#paypalQrCode').modal('show');
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error:", error);
                            toastError("Đã xảy ra lỗi khi thanh toán", 3000)
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    toastError("Đã xảy ra lỗi khi thanh toán", 3000)
                }
            });
        }
    }

    function successSwal(orderId)
    {
        Swal.fire({
            icon: 'success',
            title: 'Thanh toán thành công!',
            html: `Thanh toán đơn #<b>${orderId}</b> thành công.`,

            showCloseButton: false, // Hides the default 'x' button
            showCancelButton: true, // Shows the "Close" button
            showConfirmButton: true, // Shows the "Print Receipt" button

            confirmButtonText: '<i class="fa fa-print"></i> In hóa đơn',
            confirmButtonAriaLabel: 'In hóa đơn',
            confirmButtonColor: '#3085d6',

            cancelButtonText: 'Đóng',
            cancelButtonAriaLabel: 'Đóng',
            cancelButtonColor: '#6e7881',

        }).then((result) => {
            /* Read more about isConfirmed, isDenied below */
            if (result.isConfirmed) {
                printReceipt(cartProduct, tax, total)
                closeAllModals()
                cancel();

            } else if (result.isDismissed) {
                closeAllModals()
                cancel();
            }
        });
    }

    function printReceipt(products, tax, total) {
        const itemsHtml = products.map(item => `
        <tr class="service">
            <td class="tableitem"><p class="itemtext">${item.name}</p></td>
            <td class="tableitem"><p class="itemtext">${item.amount}</p></td>
            <td class="tableitem"><p class="itemtext">$${(item.price * item.amount).toFixed(2)}</p></td>
        </tr>
    `).join('');

        let innerHtml = `<style>
#invoice-POS{
  box-shadow: 0 0 1in -0.25in rgba(0, 0, 0, 0.5);
  padding:2mm;
  margin: 0 auto;
  width: 44mm;
  background: #FFF;


::selection {background: #f31544; color: #FFF;}
::moz-selection {background: #f31544; color: #FFF;}
h1{
  font-size: 1.5em;
  color: #222;
}
h2{font-size: .9em;}
h3{
  font-size: 1.2em;
  font-weight: 300;
  line-height: 2em;
}
p{
  font-size: .7em;
  color: #666;
  line-height: 1.2em;
}

#top, #mid,#bot{ /* Targets all id with 'col-' */
  border-bottom: 1px solid #EEE;
}

#mid{min-height: 80px;}
#bot{ min-height: 50px;}

.info{
  display: block;
  //float:left;
  margin-left: 0;
}
.title{
  float: right;
}
.title p{text-align: right;}
table{
  width: 100%;
  border-collapse: collapse;
}
td{
  //padding: 5px 0 5px 15px;
  //border: 1px solid #EEE
}
.tabletitle{
  //padding: 5px;
  font-size: .5em;
  background: #EEE;
}
.service{border-bottom: 1px solid #EEE;}
.item{width: 24mm;}
.itemtext{font-size: .5em;}

#legalcopy{
  margin-top: 5mm;
}



}
            </style>

            <div id="invoice-POS">

    <center id="top">
      <div class="info">
        <h2>Nexia gym</h2>
      </div><!--End Info-->
    </center><!--End InvoiceTop-->

    <div id="mid">
      <div class="info">
        <h2>Thông tin liên lạc</h2>
        <p>
            Address : Hoài đức, Hà nội</br>
            Email   : sonnc2252003@gmail.com</br>
            Phone   : 555-555-5555</br>
        </p>
      </div>
    </div><!--End Invoice Mid-->

    <div id="bot">

<div id="table">
<table>
<tr class="tabletitle">
<td class="item"><h2>Sản phẩm</h2></td>
<td class="Hours"><h2>Số lượng</h2></td>
<td class="Rate"><h2>Giá</h2></td>
</tr>

${itemsHtml}


<tr class="tabletitle">
<td></td>
<td class="Rate"><h2>Thuế</h2></td>
<td class="payment"><h2>$${tax.toFixed(2)}</h2></td>
</tr>

<tr class="tabletitle">
<td></td>
<td class="Rate"><h2>Tổng</h2></td>
<td class="payment"><h2>$${total.toFixed(2)}</h2></td>
</tr>

</table>
</div><!--End Table-->

<div id="legalcopy">
<p class="legal"><strong>Xin cảm ơn Quý khách đã mua hàng tại Nexia gym. Hẹn gặp lại!</strong>
</p>
</div>

</div><!--End InvoiceBot-->
  </div><!--End Invoice-->
`

        Popup(innerHtml);
    }

    function Popup(data)
    {
        var myWindow = window.open('', 'Receipt', 'height=800,width=1200');
        myWindow.document.write('<html><head><title>Receipt</title>');
        /*optional stylesheet*/ //myWindow.document.write('<link rel="stylesheet" href="main.css" type="text/css" />');
        myWindow.document.write('<style type="text/css"> *, html {margin:0;padding:0;} </style>');
        myWindow.document.write('</head><body>');
        myWindow.document.write(data);
        myWindow.document.write('</body></html>');
        myWindow.document.close(); // necessary for IE >= 10

        myWindow.onload=function(){ // necessary if the div contain images

            myWindow.focus(); // necessary for IE >= 10
            myWindow.print();
            myWindow.close();
        };
    }

    function openQrWindow(url) {
        // Define the dimensions and properties of the new window
        const windowWidth = 500;
        const windowHeight = 500;

        // Calculate the position to center the window on the screen
        const left = (screen.width / 2) - (windowWidth / 2);
        const top = (screen.height / 2) - (windowHeight / 2);

        // Define the features of the window (no toolbars, menus, etc.)
        const windowFeatures = `
                width=${windowWidth},
                height=${windowHeight},
                top=${top},
                left=${left},
                menubar=no,
                toolbar=no,
                location=no,
                status=no,
                resizable=yes,
                scrollbars=no
            `;

        // Open the new window
        window.open(url, "qrCodeWindow", windowFeatures);
    }

    document.addEventListener("DOMContentLoaded", function() {
        const paypalSocket = new SockJS('http://localhost:8086/nexia-cms/paypal-websocket');
        const paypalStompClient = Stomp.over(paypalSocket);

        const errorCallback = function (error) {
            console.error("Could not connect to WebSocket. Retrying in 5 seconds...", error);
            setTimeout(connectPaypal, 5000); // Simple auto-reconnect logic
        };

        const paypalCallBack = function(frame) {
            console.log('Successfully connected to WebSocket hub: ' + frame);
            paypalStompClient.subscribe('/topic/paypal', function (message) {
                const data = JSON.parse(message.body);
                if(data.code === 200)
                {
                    successSwal(data.data)
                }
                else {
                    toastError(data.data, 5000)
                    closeAllModals()
                }
            })
        }

        function connectPaypal() {
            paypalStompClient.connect({}, paypalCallBack, errorCallback)
        }
        connectPaypal();
    })

    function closeAllModals() {
        // 1. Select all modals that are currently visible
        // The .show class is added by Bootstrap when a modal is opened.
        const openModals = $('.modal.show');

        if (openModals.length > 0) {
            console.log(`Found ${openModals.length} open modal(s). Closing them now.`);

            // 2. Iterate over each of them
            openModals.each(function() {
                // 3. Call the official Bootstrap 'hide' method on the current modal
                $(this).modal('hide');
            });
        } else {
            console.log('No open modals found.');
        }
    }

    function showLoadingAlert() {
        Swal.fire({
            title: 'Đang xử lý...',
            html: 'Yêu cầu của bạn đang được xử lý.',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function getPreviousReceipt()
    {
        $.ajax({
            url: 'http://localhost:8086/nexia-cms/product-order/get-previous-order',
            type: 'GET',
            success: function(response) {
                const data = response.data
                printReceipt(data.products, data.tax, data.total);
            },
            error: function(error) {
                console.error('Error fetching posts:', error);
                toastError("Xảy ra lỗi khi in hóa đơn", 5000)
            }
        });
    }

    $(function() {
        $("#paymentGateway").val($("#paymentGatewaySelect").val());
        $("#paymentGatewaySelect").on("change", function() {
            $("#paymentGateway").val($(this).val());
        });
        $('#addPayment #type').on('change', function() {
            if ($(this).val() == 0) {
                $('#addPayment #paymentGatewaySelect').val('cash').prop('disabled', true);
                $("#paymentGateway").val('cash');
            } else {
                $('#addPayment #paymentGatewaySelect').prop('disabled', false);
            }
        });
        $("#addPayment #create-payment").click(function() {
            if($('#addPayment #paymentGateway').val() == 'paypal'){
                var cashPayment = 'http://localhost:8086/nexia-cms/payment/save-paypal';
                $("#create-payment-form").attr("action", cashPayment);
            }
            else {
                var cashPayment = 'http://localhost:8086/nexia-cms/payment/save-cash';
                $("#create-payment-form").attr("action", cashPayment);
            }
        });
    });

</script>
</body>
</html>