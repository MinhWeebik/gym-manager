<!DOCTYPE html>
<html lang="en" layout:decorate="~{cms_layout_1.html}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
</head>
<body>
<div class="content" layout:fragment="page_content">
  <div class="container-fluid">
    <div class="card card-default">
      <div class="card-body">
        <div class="mb-3">
          <a th:href="@{/music/home-content/{type}/index(type = ${type})}" type="button" class="btn btn-danger mx-2">
            <i class="fa-solid fa-arrow-left"></i><span class="px-2">Back</span>
          </a>
          <button onclick="$('#modal-search-song').modal('show');" type="button" class="btn btn-primary my-0">
            <i class="fas fa-plus"></i><span class="px-2">
            <span th:if="${type=='audiobook'}" th:text="#{addAudiobook}"></span>
            <span th:if="${type=='podcast'}" th:text="#{addPodcast}"></span>
          </span>
          </button>
        </div>

        <div class="table-responsive mb-2 mt-3">
          <table class="table table-sm custom-table table-bordered table-hover text-center" style="table-layout: auto; width: 100%; font-weight: 600;" id="content-table">
            <thead class="thead-light align-content-center">
            <tr>
              <th th:text="#{id}"></th>
              <th th:text="#{name}"></th>
              <th th:text="#{image}" style="width: 0%"></th>
              <th th:text="#{status}" ></th>
              <th th:text="#{typeEarn}" style="width: 10%"></th>
              <th th:text="#{publishedTime}" th:if="${type=='audiobook'}"></th>
              <th th:text="#{createdAt}"></th>
              <th th:text="#{totalListens}" style="width: 10%"></th>
              <th></th>
            </tr>
            </thead>
            <tbody id="bodyTableContext">
            <tr th:each="model,item : ${type=='audiobook' ? modelConfig.audiobookList : modelConfig.podcastList}" th:attr="data-id=${model.id}">
              <td th:text="${model.id}" style="align-content: center;"></td>
              <td th:text="${model.name}" style="align-content: center;"></td>
              <td>
                <div class="dropdown">
                  <img class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" th:onerror="this.onerror=null; this.src=[[${@environment.getProperty('domain.nginx')}]] + '/img/no-image-square.jpg';"
                       style="height: 60px;width:60px" th:src="${@environment.getProperty('domain.nginx')} + ${model.image}">
                  <div class="dropdown-menu p-1" aria-labelledby="dropdownMenu2">
                    <img style="height: 200px;width:200px" th:src="${@environment.getProperty('domain.nginx')} + ${model.image}" th:onerror="this.onerror=null; this.src=[[${@environment.getProperty('domain.nginx')}]] + '/img/no-image-square.jpg';">
                  </div>
                </div>
              </td>
              <td style="align-content: center;">
                <span th:if="${model.status == 0}" class="badge badge-danger" style="white-space: normal; cursor: pointer;">Inactive</span>
                <span th:if="${model.status == 1}" class="badge badge-success" style="white-space: normal; cursor: pointer">Active</span>
                <span th:if="${model.status == -1}" class="badge badge-danger" style="white-space: normal; cursor: pointer;">Deleted</span>
              </td>
              <td style="align-content: center;">
                <span th:if="${model.typeEarn == 0}" class="badge badge-light" style="white-space: normal; cursor: pointer;">Free</span>
                <span th:if="${model.typeEarn == 1}" class="badge badge-warning" style="white-space: normal; cursor: pointer">Coin</span>
                <span th:if="${model.typeEarn == 2}" class="badge badge-success" style="white-space: normal; cursor: pointer;">Money</span>
              </td>
              <td th:text="${#dates.format(new java.util.Date(model.publisherDate), 'dd/MM/yyyy')}" style="align-content: center;" th:if="${type=='audiobook'}"></td>
              <td th:text="${#dates.format(new java.util.Date(model.createdAt), 'dd/MM/yyyy HH:mm:ss')}" style="align-content: center;"></td>
              <td th:text="${model.totalListen}" style="align-content: center;"></td>

              <td style="align-content: center;">
                <div class="d-flex flex-row justify-content-center">
                  <a th:attr="onclick=|removeSong(event, ${model?.id})|" style="cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Delete" class="btn btn-sm">
                    <i class="fas fa-trash-alt" style="color: #ff0000;"></i>
                  </a>
                </div>
              </td>
            </tr>
                                    <tr id="no-result" style="display: none">
                                        <td colspan="100">No result</td>
                                    </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <modal-search-song th:if="${type}" th:replace="music/home/modal_search :: modal-search-content(@{/music/home-content/{type}/get-content-ids(type = ${type})}, ${modelConfig.id})"></modal-search-song>
</div>
<!-- PAGE JAVASCRIPT CODE -->
<script layout:fragment="content_page_script">
  countRow();
  function addSong(e, id) {
    $.ajax({
      url: '[[@{/music/home-content/{type}/add-content(type = ${type})}]]',
      type: 'POST',
      data: {
        configId: '[[${modelConfig.id}]]',
        contentId: id
      },
      xhrFields: {
        withCredentials: true
      },
      success: function(data) {
        console.log(data);
        let trNew = $('<tr></tr>');
        let tr = $(e.target).closest('tr');

        tr.find('td').slice(1).each(function() {
          trNew.append($(this).clone());
        });

        trNew.append(`
                    <td style="align-content: center;">
                        <div class="d-flex flex-row justify-content-center">
                            <a onclick="removeSong(event, ${id})" style="cursor: pointer; align-content: center;" title="Delete" class="btn btn-sm">
                                <i class="fas fa-trash-alt" style="color: #ff0000;"></i>
                            </a>
                        </div>
                    </td>
                `);

        $('#bodyTableContext').prepend(trNew);
        tr.remove();
        writeIndex();
        countRow();
        searchSong(null, true);
        countRow();
      },
      error: function(xhr, status, error) {
        toastError("Error adding content!", 3000);
      }
    });
  }

  function removeSong(e, id) {
    toastLoading();

    $.ajax({
      url: '[[@{/music/home-content/remove-content}]]',
      type: 'POST',
      data: {
        configId: '[[${modelConfig.id}]]',
        contentId: id
      },
      xhrFields: {
        withCredentials: true
      },
      success: function(data) {
        console.log(data);
        $(e.target).closest('tr').remove();
        writeIndex();
        toastSuccess("Success!", 3000);
        searchSong(null, true);
        countRow();
      },
      error: function(xhr, status, error) {
        toastError("Error removing content!", 3000);
      }
    });
  }

  var cacheTimeout;
  function writeIndex() {
    clearTimeout(cacheTimeout);
    cacheTimeout = setTimeout(() => {
      $('#bodyTableContext').find('tr').each(function(index, item) {
        console.log(index)
        $(item).find('.index').text(index + 1);
      });
    }, 300);
  }

  function countRow()
  {
    let rowCount = $('#content-table tbody tr').length;
    console.log("row count: " + rowCount)
    if(rowCount === 1)
    {
      $('#no-result').show()
    }
    else
    {
      $('#no-result').hide()
    }
  }
</script>
</body>
</html>